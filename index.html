<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GoJS 并行线路演示（可拖动节点）</title>
    <script src="https://unpkg.com/gojs/release/go.js"></script>
    <script src="./ParallelRouteLink.js"></script>
    <style>
      :root {
        color-scheme: light;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at top, #f1f5f9 0%, #e2e8f0 35%, #cbd5f5 100%);
        min-height: 100vh;
        color: #0f172a;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: clamp(20px, 4vw, 36px) clamp(20px, 4vw, 48px) clamp(10px, 2vw, 20px);
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 64, 175, 0.9));
        color: #f8fafc;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.35);
        position: relative;
        overflow: hidden;
      }

      header::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.35), transparent 55%),
          radial-gradient(circle at 80% 30%, rgba(129, 140, 248, 0.45), transparent 50%);
        pointer-events: none;
        mix-blend-mode: screen;
      }

      header h1 {
        margin: 0 0 8px;
        font-size: clamp(26px, 4vw, 40px);
        letter-spacing: 0.03em;
      }

      header p {
        margin: 0;
        max-width: 760px;
        line-height: 1.7;
        opacity: 0.86;
      }

      main {
        flex: 1;
        padding: clamp(18px, 4vw, 32px);
        display: grid;
        gap: clamp(18px, 4vw, 32px);
      }

      .controls {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        align-items: end;
      }

      .control-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 18px;
        padding: 18px 20px 20px;
        box-shadow: 0 14px 35px rgba(15, 23, 42, 0.18);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      .control-card h3 {
        margin: 0 0 14px;
        font-size: 16px;
        letter-spacing: 0.06em;
        color: #1e293b;
      }

      .slider-group,
      .color-group {
        display: flex;
        align-items: center;
        gap: 14px;
        justify-content: space-between;
      }

      .slider-group input[type="range"] {
        flex: 1 1 auto;
        accent-color: #2563eb;
      }

      .slider-value {
        min-width: 42px;
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      label {
        display: block;
        font-size: 13px;
        letter-spacing: 0.04em;
        color: #475569;
      }

      input[type="color"] {
        width: 54px;
        height: 32px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
      }

      button {
        appearance: none;
        border: none;
        padding: 12px 20px;
        border-radius: 999px;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: #f8fafc;
        font-weight: 600;
        letter-spacing: 0.04em;
        cursor: pointer;
        box-shadow: 0 10px 28px rgba(37, 99, 235, 0.35);
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 32px rgba(37, 99, 235, 0.45);
      }

      select {
        width: 100%;
        padding: 10px 14px;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.95);
        color: #1e293b;
        font-size: 14px;
        letter-spacing: 0.03em;
        box-shadow: inset 0 1px 3px rgba(15, 23, 42, 0.08);
        appearance: none;
      }

      select:focus {
        outline: none;
        border-color: rgba(37, 99, 235, 0.6);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      }

      .control-hint {
        margin-top: 10px;
        font-size: 12px;
        line-height: 1.6;
        color: #64748b;
        letter-spacing: 0.04em;
      }

      #diagramContainer {
        position: relative;
        border-radius: 26px;
        min-height: clamp(520px, 60vh, 720px);
        background: rgba(248, 250, 252, 0.82);
        box-shadow: 0 24px 50px rgba(15, 23, 42, 0.24);
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      #myDiagramDiv {
        width: 100%;
        height: 100%;
      }

      .legend {
        position: absolute;
        top: 18px;
        right: 18px;
        background: rgba(15, 23, 42, 0.9);
        color: #f8fafc;
        border-radius: 16px;
        padding: 18px;
        font-size: 13px;
        min-width: 220px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
        backdrop-filter: blur(8px);
      }

      .legend h3 {
        margin: 0 0 10px;
        font-size: 14px;
        letter-spacing: 0.08em;
        opacity: 0.85;
      }

      .legend ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 10px;
      }

      .legend li {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .legend span.swatch {
        width: 18px;
        height: 4px;
        border-radius: 999px;
        display: inline-block;
      }

      @media (max-width: 860px) {
        header {
          text-align: center;
        }

        .legend {
          position: static;
          margin: 16px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>GoJS 并行线路演示</h1>
      <p>
        这个示例展示了 <strong>ParallelRouteLink</strong> 扩展在电力/地铁线路图中的应用。
        通过调节并行间距、颜色与节点位置，帮助你直观预览多回路线路的视觉效果。
      </p>
    </header>
    <main>
      <section class="controls">
        <article class="control-card">
          <h3>并行间距</h3>
          <div class="slider-group">
            <label for="spacingInput">Parallel spacing</label>
            <input id="spacingInput" type="range" min="4" max="32" value="10" />
            <span id="spacingValue" class="slider-value">10px</span>
          </div>
        </article>
        <article class="control-card">
          <h3>线路走向</h3>
          <label for="routingMode">路线风格</label>
          <select id="routingMode">
            <option value="free" selected>自由走向（可斜线、平行偏移）</option>
            <option value="orthogonal">正交走向（自动避开节点）</option>
          </select>
          <p class="control-hint">切换为“自由走向”即可让并行线路按照节点位置自动呈现斜向/斜率一致的效果。</p>
        </article>
        <article class="control-card">
          <h3>线路配色</h3>
          <div class="color-group">
            <label for="kcColor">金安 ↔ 彩电</label>
            <input id="kcColor" type="color" value="#c62828" />
          </div>
          <div class="color-group">
            <label for="cgColor">彩电 ↔ 绿荷</label>
            <input id="cgColor" type="color" value="#ad1457" />
          </div>
          <div class="color-group">
            <label for="sfColor">上闸 ↔ 范家</label>
            <input id="sfColor" type="color" value="#6a1b9a" />
          </div>
        </article>
        <article class="control-card">
          <h3>视图</h3>
          <div style="display: flex; gap: 12px; flex-wrap: wrap">
            <button type="button" id="fitButton">缩放以适应</button>
            <button type="button" id="resetButton">重置节点布局</button>
          </div>
        </article>
      </section>
      <section id="diagramContainer">
        <div id="myDiagramDiv" role="presentation" aria-label="GoJS diagram preview"></div>
        <aside class="legend">
          <h3>线路分组</h3>
          <ul class="legend-colors">
            <li><span class="swatch" data-pair="kc"></span>金安 ↔ 彩电（双回路）</li>
            <li><span class="swatch" data-pair="cg"></span>彩电 ↔ 绿荷（三回路）</li>
            <li><span class="swatch" data-pair="sf"></span>上闸 ↔ 范家（四回路）</li>
            <li><span class="swatch" data-pair="single"></span>普通单线</li>
          </ul>
          <h3 style="margin-top: 18px">操作提示</h3>
          <ul class="legend-tips">
            <li>拖动任一站点即可调整位置。</li>
            <li>拖动滑块可调整多回路之间的间距。</li>
            <li>使用颜色选择器快速预览不同线路配色。</li>
            <li>点击“重置节点布局”恢复初始状态。</li>
          </ul>
        </aside>
      </section>
    </main>

    <script>
      (() => {
        const $ = go.GraphObject.make;

        const initialNodeData = [
          { key: "金安站", loc: "-80 -40" },
          { key: "彩电站", loc: "220 -140" },
          { key: "上闸站", loc: "520 -20" },
          { key: "周西站", loc: "40 180" },
          { key: "绿荷站", loc: "360 210" },
          { key: "范家站", loc: "760 120" }
        ];

        const baseLinks = [];

        function addParallel(from, to, count, stroke) {
          for (let i = 0; i < count; i += 1) {
            baseLinks.push({ category: "parallel", from, to, stroke, parallelIndex: i });
          }
        }

        const singleLinks = [
          { category: "single", from: "金安站", to: "周西站" },
          { category: "single", from: "周西站", to: "绿荷站" }
        ];

        addParallel("金安站", "彩电站", 2, document.getElementById("kcColor").value);
        addParallel("彩电站", "绿荷站", 3, document.getElementById("cgColor").value);
        addParallel("上闸站", "范家站", 4, document.getElementById("sfColor").value);

        const diagram = $(go.Diagram, "myDiagramDiv", {
          "undoManager.isEnabled": true,
          padding: 24,
          contentAlignment: go.Spot.Center,
          isReadOnly: false,
          allowLinkReshaping: true
        });

        diagram.grid = $(
          go.Panel,
          "Grid",
          { visible: false },
          $(go.Shape, "LineH", { stroke: "rgba(148, 163, 184, 0.18)", strokeWidth: 1 }),
          $(go.Shape, "LineV", { stroke: "rgba(148, 163, 184, 0.18)", strokeWidth: 1 })
        );

        diagram.nodeTemplate = $(
          go.Node,
          "Spot",
          {
            locationSpot: go.Spot.Center,
            movable: true,
            resizable: false,
            cursor: "grab",
            shadowVisible: true,
            mouseEnter: (e, node) => (node.cursor = "grabbing"),
            mouseLeave: (e, node) => (node.cursor = "grab")
          },
          new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
          $(
            go.Panel,
            "Auto",
            { name: "PANEL", portId: "" },
            $(go.Shape, "Circle", {
              fill: "white",
              stroke: "#2563eb",
              strokeWidth: 3,
              desiredSize: new go.Size(68, 68)
            }),
            $(
              go.TextBlock,
              {
                font: "600 14px 'Segoe UI', 'Microsoft YaHei', sans-serif",
                stroke: "#1e293b"
              },
              new go.Binding("text", "key")
            )
          )
        );

        const singleLinkTemplate = $(
          go.Link,
          {
            routing: go.Link.Normal,
            corner: 0,
            relinkableFrom: true,
            relinkableTo: true,
            resegmentable: true,
            adjusting: go.Link.None
          },
          $(go.Shape, { isPanelMain: true, stroke: "#ef6c00", strokeWidth: 3 })
        );

        const parallelLinkTemplate = $(
          ParallelRouteLink,
          {
            routing: go.Link.Normal,
            corner: 0,
            relinkableFrom: true,
            relinkableTo: true,
            resegmentable: true,
            adjusting: go.Link.None,
            parallelSpacing: Number(document.getElementById("spacingInput").value)
          },
          $(go.Shape, { isPanelMain: true, strokeWidth: 3 }, new go.Binding("stroke", "stroke"))
        );

        diagram.linkTemplateMap.add("single", singleLinkTemplate);
        diagram.linkTemplateMap.add("parallel", parallelLinkTemplate);

        diagram.model = new go.GraphLinksModel(initialNodeData, [...singleLinks, ...baseLinks]);

        window.diagram = diagram;

        function updateLegendSwatches() {
          const colors = {
            kc: document.getElementById("kcColor").value,
            cg: document.getElementById("cgColor").value,
            sf: document.getElementById("sfColor").value,
            single: "#ef6c00"
          };
          document.querySelectorAll(".legend-colors span.swatch").forEach((swatch) => {
            const key = swatch.dataset.pair;
            swatch.style.background = colors[key] || "#94a3b8";
          });
        }

        function setParallelColor(pair, color) {
          diagram.model.commit((model) => {
            model.linkDataArray.forEach((linkData) => {
              if (
                linkData.category === "parallel" &&
                ((linkData.from === pair[0] && linkData.to === pair[1]) ||
                  (linkData.from === pair[1] && linkData.to === pair[0]))
              ) {
                model.set(linkData, "stroke", color);
              }
            });
          }, "updateParallelColor");
          updateLegendSwatches();
        }

        function applyParallelSpacing(spacing) {
          diagram.startTransaction("updateParallelSpacing");
          diagram.links.each((link) => {
            if (link instanceof ParallelRouteLink) {
              link.parallelSpacing = spacing;
              link.invalidateRoute();
            }
          });
          diagram.commitTransaction("updateParallelSpacing");
        }

        function applyRoutingMode(mode) {
          const useOrthogonal = mode === "orthogonal";
          const routing = useOrthogonal ? go.Link.AvoidsNodes : go.Link.Normal;
          const corner = useOrthogonal ? 6 : 0;
          const adjusting = useOrthogonal ? go.Link.End : go.Link.None;

          singleLinkTemplate.routing = routing;
          singleLinkTemplate.corner = corner;
          singleLinkTemplate.adjusting = adjusting;

          parallelLinkTemplate.routing = routing;
          parallelLinkTemplate.corner = corner;
          parallelLinkTemplate.adjusting = adjusting;

          diagram.startTransaction("updateRoutingMode");
          diagram.links.each((link) => {
            link.routing = routing;
            link.corner = corner;
            link.adjusting = adjusting;
            if (link instanceof ParallelRouteLink) {
              link.invalidateRoute();
            }
          });
          diagram.commitTransaction("updateRoutingMode");

          diagram.grid.visible = useOrthogonal;
          diagram.toolManager.draggingTool.isGridSnapEnabled = useOrthogonal;
          if (useOrthogonal) {
            diagram.toolManager.draggingTool.gridSnapCellSize = new go.Size(30, 30);
          }
        }

        const spacingInput = document.getElementById("spacingInput");
        const spacingValue = document.getElementById("spacingValue");
        spacingInput.addEventListener("input", (event) => {
          const value = Number(event.target.value);
          spacingValue.textContent = `${value}px`;
          applyParallelSpacing(value);
        });

        const routingMode = document.getElementById("routingMode");
        routingMode.addEventListener("change", (event) => {
          applyRoutingMode(event.target.value);
        });

        document.getElementById("kcColor").addEventListener("input", (event) => {
          setParallelColor(["金安站", "彩电站"], event.target.value);
        });
        document.getElementById("cgColor").addEventListener("input", (event) => {
          setParallelColor(["彩电站", "绿荷站"], event.target.value);
        });
        document.getElementById("sfColor").addEventListener("input", (event) => {
          setParallelColor(["上闸站", "范家站"], event.target.value);
        });

        document.getElementById("fitButton").addEventListener("click", () => {
          diagram.commandHandler.zoomToFit();
        });

        const initialLocations = new Map();
        diagram.nodes.each((node) => {
          if (node.data && node.data.loc) {
            initialLocations.set(node.data.key, node.data.loc);
          }
        });

        document.getElementById("resetButton").addEventListener("click", () => {
          diagram.commit((model) => {
            initialLocations.forEach((loc, key) => {
              const data = model.findNodeDataForKey(key);
              if (data) model.set(data, "loc", loc);
            });
          }, "resetLocations");
          diagram.commandHandler.zoomToFit();
        });

        diagram.addDiagramListener("InitialLayoutCompleted", () => {
          diagram.commandHandler.zoomToFit();
          updateLegendSwatches();
        });

        applyParallelSpacing(Number(spacingInput.value));
        applyRoutingMode(routingMode.value);
        updateLegendSwatches();
      })();
    </script>
  </body>
</html>
