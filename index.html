<!DOCTYPE html>
<html>
  <head>
    <title>电力系统图 GoJS (V15 - 官方折线工具)</title>
    <meta
      name="description"
      content="集成官方 LinkReshapingTool，实现最流畅的“任意点弯折”交互"
    />
    <meta charset="utf-8" />
    <style>
      #myDiagramDiv {
        border: 1px solid black;
        width: 100%;
        height: 800px;
      }
    </style>
  </head>
  <body>
    <h1>电力系统图 GoJS (V15 - 官方折线工具)</h1>
    <p>
      最终方案：默认平行直线。<b>将鼠标悬停在线路上</b>，拖拽出现的中点手柄即可流畅添加折点。
    </p>
    <div id="myDiagramDiv"></div>
    <script src="https://unpkg.com/gojs/release/go.js"></script>
    <script>
      // ### 智能的 ParallelRouteLink 定义 (无变化) ###
      class ParallelRouteLink extends go.Link {
        constructor(init) {
          super();
          if (init) Object.assign(this, init);
        }
        computePoints() {
          if (this.pointsCount > 2) {
            return super.computePoints();
          }
          const result = super.computePoints();
          if (
            this.isOrthogonal ||
            this.curve === go.Curve.Bezier ||
            !this.hasCurviness()
          ) {
            return result;
          }
          const curv = this.computeCurviness();
          if (curv === 0) return result;
          const fromnode = this.fromNode;
          const tonode = this.toNode;
          if (!fromnode || !tonode) return result;
          const frompt = this.getPoint(0);
          const topt = this.getPoint(this.pointsCount - 1);
          const dx = topt.x - frompt.x;
          const dy = topt.y - frompt.y;
          const perpendicular = new go.Point(-dy, dx);
          perpendicular.normalize();
          perpendicular.x *= curv;
          perpendicular.y *= curv;
          const newFromPt = new go.Point(
            frompt.x + perpendicular.x,
            frompt.y + perpendicular.y
          );
          const newToPt = new go.Point(
            topt.x + perpendicular.x,
            topt.y + perpendicular.y
          );
          this.clearPoints();
          this.addPoint(newFromPt);
          this.addPoint(newToPt);
          return true;
        }
      }

      // ### 引入官方 LinkReshapingTool (已修正) ###
      class LinkReshapingTool extends go.Tool {
        constructor(init) {
          super();
          this.name = "LinkReshaping";
          this._handleArchetype = new go.Shape({
            fill: "lightblue",
            stroke: "dodgerblue",
            strokeWidth: 2,
            desiredSize: new go.Size(8, 8),
          });
          this._midHandleArchetype = new go.Shape({
            fill: "lightblue",
            stroke: "dodgerblue",
            strokeWidth: 2,
            desiredSize: new go.Size(7, 7),
            cursor: "move",
          });
          this._adornmentTemplate = new go.Adornment("Link");
          this._handle = null;
          this._adornedLink = null;
          this._originalPoints = null;
          if (init) Object.assign(this, init);
        }
        get handleArchetype() {
          return this._handleArchetype;
        }
        set handleArchetype(value) {
          this._handleArchetype = value;
        }
        get midHandleArchetype() {
          return this._midHandleArchetype;
        }
        set midHandleArchetype(value) {
          this._midHandleArchetype = value;
        }
        get adornmentTemplate() {
          return this._adornmentTemplate;
        }
        set adornmentTemplate(value) {
          this._adornmentTemplate = value;
        }
        makeAdornment(link) {
          const ad = this.adornmentTemplate.copy();
          ad.adornedObject = link;
          if (this.handleArchetype) {
            for (let i = 0; i < link.pointsCount; i++) {
              const h = this.handleArchetype.copy();
              h.pointIndex = i;
              ad.add(h);
            }
          }
          if (this.midHandleArchetype) {
            for (let i = 0; i < link.pointsCount - 1; i++) {
              const h = this.midHandleArchetype.copy();
              h.segmentIndex = i;
              ad.add(h);
            }
          }
          // ad.category = 'Reshaping'; // <-- 错误的代码已被移除
          return ad;
        }
        updateAdornments(part) {
          if (!(part instanceof go.Link)) return;
          const link = part;
          if (link.isSelected && !this.diagram.isReadOnly) {
            const ad =
              link.findAdornment(this.name) || this.makeAdornment(link);
            if (ad) {
              ad.location = link.routeBounds.position;
              link.addAdornment(this.name, ad);
            }
          } else {
            link.removeAdornment(this.name);
          }
        }
        canStart() {
          if (!this.isEnabled) return false;
          const diagram = this.diagram;
          if (diagram.isReadOnly) return false;
          if (!diagram.lastInput.left) return false;
          const h = this.findToolHandleAt(
            diagram.firstInput.documentPoint,
            this.name
          );
          return h !== null || this.isBeyondDragSize();
        }
        doActivate() {
          const diagram = this.diagram;
          const h = this.findToolHandleAt(
            diagram.firstInput.documentPoint,
            this.name
          );
          if (h) {
            const link = h.part.adornedObject;
            if (link) {
              this._adornedLink = link;
              this._handle = h;
              this._originalPoints = link.points.copy();
              this.startTransaction(this.name);
              diagram.isMouseCaptured = true;
              this.isActive = true;
            }
          } else {
            const link = diagram.findPartAt(
              diagram.lastInput.documentPoint,
              false
            );
            if (
              link instanceof go.Link &&
              link.canReshape() &&
              link.pointsCount > 1
            ) {
              this._adornedLink = link;
              const points = link.points.copy();
              const first = diagram.firstInput.documentPoint;
              const idx = link.findClosestSegment(first) + 1;
              points.insertAt(idx, first);
              link.points = points;
              this._originalPoints = points;
              const ad = this.makeAdornment(link);
              link.addAdornment(this.name, ad);
              this._handle = ad.findObjectAt(
                first,
                null,
                (x) => x.pointIndex === idx
              );
              this.startTransaction(this.name);
              diagram.isMouseCaptured = true;
              this.isActive = true;
            }
          }
        }
        doDeactivate() {
          this.isActive = false;
          this.diagram.isMouseCaptured = false;
          this.stopTransaction();
          this._handle = null;
          this._adornedLink = null;
          this._originalPoints = null;
        }
        doCancel() {
          if (this._originalPoints) {
            this._adornedLink.points = this._originalPoints;
          }
          this.stopTool();
        }
        doMouseMove() {
          if (this.isActive) {
            const newpt = this.computeReshape(
              this.diagram.lastInput.documentPoint
            );
            this.reshape(newpt);
          }
        }
        doMouseUp() {
          if (this.isActive) {
            const newpt = this.computeReshape(
              this.diagram.lastInput.documentPoint
            );
            this.reshape(newpt);
            this.transactionResult = this.name;
          }
          this.stopTool();
        }
        reshape(newPoint) {
          const link = this._adornedLink;
          const h = this._handle;
          const points = link.points.copy();
          if (typeof h.pointIndex === "number") {
            points.setPoint(h.pointIndex, newPoint);
          } else if (typeof h.segmentIndex === "number") {
            points.insertAt(h.segmentIndex + 1, newPoint);
            h.pointIndex = h.segmentIndex + 1;
            delete h.segmentIndex;
          }
          link.points = points;
        }
        computeReshape(newPoint) {
          return newPoint;
        }
      }
      // --------------------------------------------------------------------------------

      const $ = go.GraphObject.make;

      const myDiagram = new go.Diagram("myDiagramDiv", {
        "undoManager.isEnabled": true,
        initialContentAlignment: go.Spot.Center,
        "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
      });

      // ### 步骤 2: 激活官方的 LinkReshapingTool ###
      myDiagram.toolManager.reshapingTool = new LinkReshapingTool();

      // 节点模板 (无变化)
      myDiagram.nodeTemplate = $(
        go.Node,
        "Spot",
        { locationSpot: go.Spot.Center, locationObjectName: "SHAPE" },
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(
          go.Point.stringify
        ),
        $(go.Shape, "Circle", {
          name: "SHAPE",
          width: 40,
          height: 40,
          fill: "white",
          stroke: "#009900",
          strokeWidth: 2,
        }),
        $(
          go.Panel,
          "Vertical",
          { alignment: go.Spot.Center },
          $(
            go.TextBlock,
            { font: "bold 11pt sans-serif" },
            new go.Binding("text", "key")
          ),
          $(
            go.TextBlock,
            { font: "9pt sans-serif" },
            new go.Binding("text", "voltage", (v) => (v ? `${v}` : ""))
          ),
          $(
            go.TextBlock,
            { font: "9pt sans-serif", stroke: "red" },
            new go.Binding("text", "g", (g) => (g ? `G: ${g}` : ""))
          ),
          $(
            go.TextBlock,
            { font: "9pt sans-serif" },
            new go.Binding("text", "l", (l) => (l ? `L: ${l}` : ""))
          )
        )
      );
      myDiagram.nodeTemplateMap.add(
        "Generator",
        $(
          go.Node,
          "Spot",
          { locationSpot: go.Spot.Center, locationObjectName: "SHAPE_PANEL" },
          new go.Binding("location", "loc", go.Point.parse).makeTwoWay(
            go.Point.stringify
          ),
          $(
            go.Panel,
            "Spot",
            { name: "SHAPE_PANEL" },
            $(go.Shape, "Rectangle", {
              width: 50,
              height: 50,
              fill: "white",
              stroke: "red",
              strokeWidth: 2,
            }),
            $(go.Shape, {
              geometryString: "M0 15 C10 0, 20 30, 30 15",
              stroke: "red",
              strokeWidth: 2,
              width: 30,
              height: 15,
              fill: null,
            })
          ),
          $(
            go.Panel,
            "Vertical",
            { alignment: go.Spot.Center, margin: 4 },
            $(
              go.TextBlock,
              { font: "bold 11pt sans-serif", stroke: "red" },
              new go.Binding("text", "key")
            ),
            $(
              go.TextBlock,
              { font: "9pt sans-serif" },
              new go.Binding("text", "voltage", (v) => (v ? `${v}` : ""))
            ),
            $(
              go.TextBlock,
              { font: "9pt sans-serif", stroke: "red" },
              new go.Binding("text", "g", (g) => `G: ${g}`)
            ),
            $(
              go.TextBlock,
              { font: "9pt sans-serif" },
              new go.Binding("text", "l", (l) => `L: ${l}`)
            )
          )
        )
      );

      // 链接模板 (无变化)
      myDiagram.linkTemplate = $(
        ParallelRouteLink,
        {
          reshapable: true, // 必须为 true，让新工具可以工作
          routing: go.Link.Normal,
        },
        new go.Binding("curviness"),
        $(
          go.Shape,
          { strokeWidth: 2, stroke: "black" },
          new go.Binding("stroke", "color")
        ),
        $(
          go.TextBlock,
          {
            segmentOffset: new go.Point(0, -10),
            font: "9pt sans-serif",
            background: "white",
          },
          new go.Binding("text", "label")
        )
      );

      // 自动分配 curviness 值的辅助函数 (无变化)
      function assignCurviness(linkDataArray) {
        const linkGroups = new Map();
        for (const link of linkDataArray) {
          const from = link.from;
          const to = link.to;
          const key = from < to ? `${from}|${to}` : `${to}|${from}`;
          if (!linkGroups.has(key)) linkGroups.set(key, []);
          linkGroups.get(key).push(link);
        }
        for (const group of linkGroups.values()) {
          if (group.length > 1) {
            const total = group.length;
            const spacing = 8;
            group.forEach((link, index) => {
              link.curviness = (index - (total - 1) / 2) * spacing;
            });
          }
        }
      }

      const nodeDataArray = [
        { key: "平寨站", l: "-168.1", loc: "0 50" },
        { key: "黎阳站", l: "-198.2", loc: "150 0" },
        { key: "新塘站", l: "-66.1", color: "red", loc: "300 50" },
        { key: "岩头寨", g: "0", l: "321.3", loc: "0 250" },
        { key: "草鞋坳", l: "-187.9", loc: "150 250" },
        { key: "翁村站", l: "-1182.0", loc: "300 200" },
        {
          key: "安民电厂",
          category: "Generator",
          g: 297.6,
          l: 19.8,
          loc: "150 400",
        },
        { key: "优的站", l: "91.3", loc: "0 500" },
        { key: "社洞基站", l: "78.4", loc: "150 600" },
        {
          key: "翁奇电厂",
          category: "Generator",
          g: 173.7,
          l: 11.4,
          loc: "650 500",
        },
        { key: "翁嘎站", l: "-153.8", loc: "150 800" },
        { key: "杨家站", l: "-105.7", loc: "300 650" },
        { key: "地罗站", l: "-153.9", loc: "450 700" },
        { key: "典郎站", l: "97.5", loc: "450 850" },
        { key: "西凉站", l: "127.2", loc: "450 500" },
        { key: "得佑站", l: "157.4", loc: "300 450" },
        { key: "排吊站", l: "7.0", loc: "450 350" },
        { key: "功德站", l: "42.5", loc: "450 250" },
        { key: "平朝站", l: "-4.7", loc: "600 300" },
        { key: "上洞站", l: "9.0", loc: "600 150" },
        { key: "挂榜站", l: "179.4", loc: "750 350" },
        { key: "佳城站", l: "0.2", loc: "750 50" },
        { key: "甲拉站", l: "121.4", loc: "900 450" },
        { key: "新塘站-分接", l: "-422.5", color: "red", loc: "450 20" },
      ];

      const linkDataArray = [
        {
          from: "平寨站",
          to: "黎阳站",
          label: "1.7070+j16.1090",
          color: "#009900",
        },
        {
          from: "黎阳站",
          to: "新塘站",
          label: "2.2390+j1.9940",
          color: "#009900",
        },
        {
          from: "黎阳站",
          to: "岩头寨",
          label: "2.9860-j660.1540",
          color: "#009900",
        },
        {
          from: "岩头寨",
          to: "新塘站-分接",
          label: "0.7000-j8.4820",
          color: "#ff0000",
        },
        {
          from: "岩头寨",
          to: "新塘站-分接",
          label: "0.7000-j8.4820",
          color: "#ff0000",
        },
        {
          from: "新塘站-分接",
          to: "佳城站",
          label: "0.7300-j8.4820",
          color: "#ff0000",
        },
        {
          from: "岩头寨",
          to: "草鞋坳",
          label: "0.7810-j8.9540",
          color: "#009900",
        },
        {
          from: "岩头寨",
          to: "优的站",
          label: "3.2180+j3.1750",
          color: "#009900",
        },
        {
          from: "优的站",
          to: "社洞基站",
          label: "0.8230+j8.0490",
          color: "#009900",
        },
        {
          from: "社洞基站",
          to: "安民电厂",
          label: "0.2880+j2.9810",
          color: "#009900",
        },
        {
          from: "社洞基站",
          to: "安民电厂",
          label: "0.2880+j2.9810",
          color: "#009900",
        },
        {
          from: "社洞基站",
          to: "安民电厂",
          label: "0.2880+j2.9810",
          color: "#009900",
        },
        {
          from: "社洞基站",
          to: "杨家站",
          label: "1.2480+j6.4480",
          color: "#009900",
        },
        {
          from: "杨家站",
          to: "翁嘎站",
          label: "2.6100+j5.1020",
          color: "#009900",
        },
        {
          from: "杨家站",
          to: "地罗站",
          label: "1.6900-j5.0020",
          color: "#009900",
        },
        {
          from: "地罗站",
          to: "典郎站",
          label: "0.4500+j1.2290",
          color: "#009900",
        },
        {
          from: "地罗站",
          to: "西凉站",
          label: "0.8820+j1.0200",
          color: "#009900",
        },
        {
          from: "西凉站",
          to: "安民电厂",
          label: "0.6690+j4.3650",
          color: "#009900",
        },
        {
          from: "安民电厂",
          to: "得佑站",
          label: "0.3320-j2.9580",
          color: "#009900",
        },
        {
          from: "安民电厂",
          to: "草鞋坳",
          label: "0.8890+j4.8610",
          color: "#009900",
        },
        {
          from: "草鞋坳",
          to: "翁村站",
          label: "4.4790-j102.6220",
          color: "#009900",
        },
        {
          from: "得佑站",
          to: "排吊站",
          label: "0.2920+j6.2620",
          color: "#009900",
        },
        {
          from: "排吊站",
          to: "功德站",
          label: "0.9190+j6.6010",
          color: "#009900",
        },
        {
          from: "功德站",
          to: "新塘站-分接",
          label: "0.7670+j5.6970",
          color: "#009900",
        },
        {
          from: "功德站",
          to: "平朝站",
          label: "0.8410+j1.066",
          color: "#009900",
        },
        {
          from: "平朝站",
          to: "上洞站",
          label: "1.0920+j1.1860",
          color: "#009900",
        },
        {
          from: "上洞站",
          to: "佳城站",
          label: "2.3100+j7.2880",
          color: "#009900",
        },
        {
          from: "佳城站",
          to: "甲拉站",
          label: "1.1190+j4.1980",
          color: "#009900",
        },
        {
          from: "甲拉站",
          to: "翁奇电厂",
          label: "1.0930+j4.1680",
          color: "#009900",
        },
        {
          from: "挂榜站",
          to: "翁奇电厂",
          label: "0.7970-j0.8870",
          color: "#009900",
        },
        {
          from: "挂榜站",
          to: "平朝站",
          label: "1.0920+j1.1860",
          color: "#009900",
        },
        {
          from: "挂榜站",
          to: "平朝站",
          label: "1.0920+j1.1860",
          color: "#009900",
        },
        {
          from: "西凉站",
          to: "翁奇电厂",
          label: "3.9860+j12.4840",
          color: "#009900",
        },
        {
          from: "西凉站",
          to: "翁奇电厂",
          label: "3.9860+j12.4840",
          color: "#009900",
        },
      ];

      assignCurviness(linkDataArray);

      myDiagram.model = new go.GraphLinksModel(nodeDataArray, linkDataArray);
    </script>
  </body>
</html>
