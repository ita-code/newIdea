<!DOCTYPE html>
<html>
  <head>
    <title>ç”µåŠ›ç³»ç»Ÿå›¾ GoJSï¼ˆä»»æ„ç‚¹å¼¯æŠ˜ + ä¿å­˜æœºåˆ¶ï¼‰</title>
    <meta
      name="description"
      content="æœ€ç»ˆç‰ˆï¼šå®ç°äº†å¹³è¡Œç›´çº¿ã€ä»»æ„ç‚¹å¼¯æŠ˜ã€å¹¶å¢åŠ äº†ä¿å­˜å’ŒåŠ è½½å¸ƒå±€çš„åŠŸèƒ½"
    />
    <meta charset="utf-8" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      #myDiagramDiv {
        border: 1px solid black;
        width: 100%;
        height: 80vh; /* ä¸ºæŒ‰é’®ç•™å‡ºç©ºé—´ */
      }
    </style>
  </head>
  <body class="p-4 font-sans">
    <div class="flex flex-col items-center mb-4">
      <h1 class="text-2xl font-bold mb-2">
        ç”µåŠ›ç³»ç»Ÿå›¾ GoJSï¼ˆå¸¦æ³¨é‡Šå’Œä¿å­˜åŠŸèƒ½ï¼‰
      </h1>
      <p class="text-sm text-gray-600 mb-2">
        æœ€ç»ˆæ–¹æ¡ˆï¼šé»˜è®¤å¹³è¡Œç›´çº¿ã€‚<b>åœ¨ä»»æ„ç‚¹ä½</b>æŒ‰ä½å¹¶æ‹–æ‹½çº¿è·¯ï¼Œå³å¯ä¸ºå…¶æ·»åŠ è‡ªå®šä¹‰æŠ˜ç‚¹ã€‚
      </p>
      <!-- æ–°å¢ï¼šä¿å­˜å’ŒåŠ è½½åŠŸèƒ½çš„æŒ‰é’® -->
      <div class="flex space-x-4">
        <button
          id="saveButton"
          class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300"
        >
          ğŸ’¾ ä¿å­˜å¸ƒå±€
        </button>
        <button
          id="loadButton"
          class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300"
        >
          ğŸ“‚ åŠ è½½å¸ƒå±€
        </button>
        <button
          id="resetButton"
          class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors duration-300"
        >
          ğŸ”„ é‡ç½®å¸ƒå±€
        </button>
      </div>
      <p id="feedback" class="text-sm text-green-500 mt-2 h-4"></p>
      <!-- ç”¨äºå‘ç”¨æˆ·æä¾›åé¦ˆä¿¡æ¯ -->
    </div>

    <div id="myDiagramDiv"></div>

    <script src="https://unpkg.com/gojs/release/go.js"></script>
    <script>
      // =================================================================================
      // ### æ ¸å¿ƒæ‰©å±• 1: æ™ºèƒ½å¹³è¡Œçº¿è·¯ç±» (ParallelRouteLink) ###
      // åŠŸèƒ½ï¼š
      // 1. é»˜è®¤æƒ…å†µä¸‹ï¼ˆçº¿è·¯åªæœ‰èµ·ç‚¹å’Œç»ˆç‚¹ï¼‰ï¼Œå®ƒä¼šæ ¹æ® curviness å€¼è®¡ç®—å‡ºä¸€æ¡å¹³è¡Œçš„ç›´çº¿ã€‚
      // 2. å½“ç”¨æˆ·æ‰‹åŠ¨ä¸ºçº¿è·¯å¢åŠ äº†æŠ˜ç‚¹å (pointsCount > 2)ï¼Œå®ƒä¼šè‡ªåŠ¨â€œæ”¾æƒâ€ï¼Œ
      //    ä¸å†è¿›è¡Œå¹³è¡Œè®¡ç®—ï¼Œè€Œæ˜¯å®Œå…¨ä¿ç•™ç”¨æˆ·è‡ªå®šä¹‰çš„æŠ˜çº¿å½¢çŠ¶ã€‚
      // =================================================================================
      class ParallelRouteLink extends go.Link {
        constructor(init) {
          super();
          if (init) Object.assign(this, init);
        }
        computePoints() {
          // å¦‚æœç”¨æˆ·å·²ç»æ·»åŠ äº†æŠ˜ç‚¹ï¼Œå°±è°ƒç”¨ GoJS çš„é»˜è®¤æ–¹æ³•æ¥ç»˜åˆ¶æŠ˜çº¿
          if (this.pointsCount > 2) {
            return super.computePoints();
          }
          // å¦åˆ™ï¼Œæ‰§è¡Œæˆ‘ä»¬çš„å¹³è¡Œç›´çº¿è®¡ç®—é€»è¾‘
          const result = super.computePoints();
          if (
            this.isOrthogonal ||
            this.curve === go.Curve.Bezier ||
            !this.hasCurviness()
          ) {
            return result;
          }
          const curv = this.computeCurviness();
          if (curv === 0) return result;
          const fromnode = this.fromNode;
          const tonode = this.toNode;
          if (!fromnode || !tonode) return result;
          const frompt = this.getPoint(0);
          const topt = this.getPoint(this.pointsCount - 1);
          const dx = topt.x - frompt.x;
          const dy = topt.y - frompt.y;
          // è®¡ç®—å‚ç›´å‘é‡å¹¶æ–½åŠ åç§»
          const perpendicular = new go.Point(-dy, dx);
          perpendicular.normalize();
          perpendicular.x *= curv;
          perpendicular.y *= curv;
          const newFromPt = new go.Point(
            frompt.x + perpendicular.x,
            frompt.y + perpendicular.y
          );
          const newToPt = new go.Point(
            topt.x + perpendicular.x,
            topt.y + perpendicular.y
          );
          this.clearPoints();
          this.addPoint(newFromPt);
          this.addPoint(newToPt);
          return true;
        }
      }

      // =================================================================================
      // ### æ ¸å¿ƒæ‰©å±• 2: ä»»æ„ç‚¹å¼¯æŠ˜å·¥å…· (AnyPointReshapeTool) ###
      // è¿™æ˜¯æ‚¨æä¾›çš„æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒ…å«äº†æ›´å®Œæ•´çš„é€»è¾‘å’Œä¼˜åŒ–ç­–ç•¥ã€‚
      // =================================================================================
      class AnyPointReshapeTool extends go.Tool {
        constructor() {
          super();
          this.name = "AnyPointReshape";
          this._adornedLink = null;
          this._pointIndex = -1;
          this._originalPoints = null;
          this._indicator = null;
          this._skipInsert = false;
          this._startPoint = null;
          this._hasInserted = false;
          this._dragThresholdSq = 64; // 8px çš„å¹³æ–¹ï¼šç”¨äºâ€œæ‹–åŠ¨é˜²æŠ–â€
          this._minBendSpacingSq = 400; // 20px çš„å¹³æ–¹ï¼šæŠ˜ç‚¹ä¹‹é—´çš„æœ€å°é—´è·
          this._minEndpointSpacingSq = 900; // 30px çš„å¹³æ–¹ï¼šæŠ˜ç‚¹è·ç¦»ç«¯ç‚¹çš„æœ€å°é—´è·
          this._straighteningTolerance = 8; // å‚è·å®¹å·®ï¼šæŠ˜ç‚¹è·ç¦»ç›´çº¿ â‰¤ 8px åˆ¤å®šä¸ºè¿‘ä¹ç›´çº¿
          this._lastInserted = null;
        }

        canStart() {
          const diagram = this.diagram;
          if (!diagram || diagram.isReadOnly) return false;
          const input = diagram.firstInput;
          if (!input.left) return false; // ä»…å“åº”å·¦é”®æŒ‰ä¸‹ï¼Œé¿å…ä¸å³é”®èœå•å†²çª
          const part = diagram.findPartAt(input.documentPoint, true);
          return part instanceof go.Link && part.canReshape();
        }

        doActivate() {
          const diagram = this.diagram;
          if (!diagram) {
            this.doCancel();
            return;
          }
          const start = diagram.firstInput.documentPoint.copy();
          const part = diagram.findPartAt(start, true);
          if (!(part instanceof go.Link)) {
            this.doCancel();
            return;
          }
          this._adornedLink = part;
          part.isHighlighted = true;
          this._originalPoints = part.points.copy();
          this._startPoint = start;
          this._pointIndex = -1;
          this._indicator = null;
          this._skipInsert = false;
          this._hasInserted = false;
          this._lastInserted = null;
          diagram.currentCursor = "grabbing";
          diagram.isMouseCaptured = true;
          this.isActive = true;
        }

        _ensureInserted(targetPoint) {
          if (this._hasInserted || this._skipInsert) return true;
          const diagram = this.diagram;
          const link = this._adornedLink;
          if (!diagram || !link) return false;
          this.startTransaction(this.name);
          const pts = link.points.copy();
          const seg = link.findClosestSegment(targetPoint);
          let insertPoint = targetPoint.copy();
          let insertIndex = seg + 1;
          let reusingExisting = false;
          for (let i = 1; i < link.pointsCount - 1; i++) {
            const existing = link.getPoint(i);
            if (
              existing &&
              existing.distanceSquaredPoint(targetPoint) <
                this._minBendSpacingSq
            ) {
              reusingExisting = true;
              insertIndex = i;
              insertPoint = existing.copy();
              break;
            }
          }
          const first = link.getPoint(0);
          const last = link.getPoint(link.pointsCount - 1);
          if (
            (first &&
              first.distanceSquaredPoint(targetPoint) <
                this._minEndpointSpacingSq) ||
            (last &&
              last.distanceSquaredPoint(targetPoint) <
                this._minEndpointSpacingSq)
          ) {
            this._skipInsert = true;
            if (this._indicator && diagram) diagram.remove(this._indicator);
            this._indicator = null;
            this._pointIndex = -1;
            this.stopTransaction();
            return false;
          }
          if (!reusingExisting) {
            for (let i = 1; i < link.pointsCount - 1; i++) {
              const existing = link.getPoint(i);
              if (
                existing &&
                existing.distanceSquaredPoint(targetPoint) <
                  this._minBendSpacingSq
              ) {
                this._skipInsert = true;
                if (this._indicator && diagram) diagram.remove(this._indicator);
                this._indicator = null;
                this._pointIndex = -1;
                this.stopTransaction();
                return false;
              }
            }
            pts.insertAt(insertIndex, insertPoint);
          }
          this._pointIndex = insertIndex;
          link.points = pts;
          this._hasInserted = true;
          this._lastInserted = { link, index: insertIndex };
          const indicator = new go.Part("Spot", {
            layerName: "Tool",
            locationSpot: go.Spot.Center,
            location: targetPoint.copy(),
            selectable: false,
            pickable: false,
          });
          indicator.add(
            new go.Shape("Circle", {
              desiredSize: new go.Size(12, 12),
              fill: "rgba(30,144,255,0.15)",
              stroke: "#1d4ed8",
              strokeWidth: 1.5,
            })
          );
          diagram.add(indicator);
          this._indicator = indicator;
          return true;
        }

        doMouseMove() {
          if (!this.isActive) return;
          const link = this._adornedLink;
          const diagram = this.diagram;
          if (!link || !diagram) return;
          const current = diagram.lastInput.documentPoint.copy();
          if (!this._hasInserted && this._startPoint) {
            const distSq = current.distanceSquaredPoint(this._startPoint);
            if (distSq >= this._dragThresholdSq) {
              this._ensureInserted(current);
            } else if (this._indicator) {
              this._indicator.location = current;
            }
          }
          if (!this._hasInserted || this._pointIndex < 0) {
            if (this._indicator) this._indicator.location = current;
            return;
          }
          const pts = link.points.copy();
          if (this._pointIndex >= 0 && this._pointIndex < link.pointsCount) {
            pts.set(this._pointIndex, current);
            link.points = pts;
          }
          if (this._indicator) this._indicator.location = current;
        }

        doMouseUp() {
          if (this.isActive && this._hasInserted) {
            this.transactionResult = this.name;
          }
          const link = this._adornedLink;
          const diagram = this.diagram;
          if (link && !this._hasInserted && diagram) {
            diagram.select(link);
          }
          this.stopTool();
        }

        doCancel() {
          if (this._adornedLink && this._originalPoints) {
            this._adornedLink.points = this._originalPoints;
          }
          this.stopTool();
        }

        stopTool() {
          const diagram = this.diagram;
          const link = this._adornedLink;
          if (diagram) {
            diagram.currentCursor = "";
          }
          if (this._indicator && diagram) {
            diagram.remove(this._indicator);
          }
          this._indicator = null;
          if (this._hasInserted) {
            this.stopTransaction();
            this._autoSimplify(link);
          }
          if (link) {
            link.isHighlighted = false;
          }
          this._adornedLink = null;
          this._originalPoints = null;
          this._pointIndex = -1;
          this._startPoint = null;
          this._hasInserted = false;
          this._skipInsert = false;
          super.stopTool();
        }

        _autoSimplify(link) {
          if (!link || typeof this._pointIndex !== "number") return;
          const idx = this._pointIndex;
          if (idx <= 0 || idx >= link.pointsCount - 1) return;
          const pts = link.points.copy();
          if (idx >= pts.length) return;
          const prev = pts.get(idx - 1);
          const curr = pts.get(idx);
          const next = pts.get(idx + 1);
          if (!prev || !curr || !next) return;
          const a2 = prev.distanceSquaredPoint(curr);
          const b2 = curr.distanceSquaredPoint(next);
          const c2 = prev.distanceSquaredPoint(next);
          let removed = false;
          if (a2 === 0 || b2 === 0) {
            pts.removeAt(idx);
            removed = true;
          } else {
            const a = Math.sqrt(a2);
            const b = Math.sqrt(b2);
            const segLength = Math.sqrt(c2);
            if (segLength > 0) {
              const area =
                Math.abs(
                  (curr.x - prev.x) * (next.y - prev.y) -
                    (curr.y - prev.y) * (next.x - prev.x)
                ) / segLength;
              if (area <= this._straighteningTolerance) {
                pts.removeAt(idx);
                removed = true;
              } else {
                const cosAngle = (a2 + b2 - c2) / (2 * a * b);
                const clamped = Math.min(1, Math.max(-1, cosAngle));
                const degrees = Math.acos(clamped) * (180 / Math.PI);
                if (degrees > 165) {
                  pts.removeAt(idx);
                  removed = true;
                }
              }
            }
          }
          if (removed) {
            const diagram = link.diagram;
            if (diagram) diagram.startTransaction("auto simplify");
            link.points = pts;
            if (diagram) diagram.commitTransaction("auto simplify");
            this._lastInserted = null;
          }
        }
      }
      // =================================================================================

      const $ = go.GraphObject.make;

      const myDiagram = new go.Diagram("myDiagramDiv", {
        "undoManager.isEnabled": true,
        initialContentAlignment: go.Spot.Center,
        "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
      });

      // ### å®‰è£…æˆ‘ä»¬çš„ç»ˆæè‡ªå®šä¹‰å·¥å…· ###
      myDiagram.toolManager.mouseDownTools.insertAt(
        0,
        new AnyPointReshapeTool()
      );

      // èŠ‚ç‚¹æ¨¡æ¿ (æ— å˜åŒ–)
      myDiagram.nodeTemplate = $(
        go.Node,
        "Spot",
        { locationSpot: go.Spot.Center, locationObjectName: "SHAPE" },
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(
          go.Point.stringify
        ),
        $(go.Shape, "Circle", {
          name: "SHAPE",
          width: 40,
          height: 40,
          fill: "white",
          stroke: "#009900",
          strokeWidth: 2,
        }),
        $(
          go.Panel,
          "Vertical",
          { alignment: go.Spot.Center },
          $(
            go.TextBlock,
            { font: "bold 11pt sans-serif" },
            new go.Binding("text", "key")
          ),
          $(
            go.TextBlock,
            { font: "9pt sans-serif" },
            new go.Binding("text", "voltage", (v) => (v ? `${v}` : ""))
          ),
          $(
            go.TextBlock,
            { font: "9pt sans-serif", stroke: "red" },
            new go.Binding("text", "g", (g) => (g ? `G: ${g}` : ""))
          ),
          $(
            go.TextBlock,
            { font: "9pt sans-serif" },
            new go.Binding("text", "l", (l) => (l ? `L: ${l}` : ""))
          )
        )
      );
      myDiagram.nodeTemplateMap.add(
        "Generator",
        $(
          go.Node,
          "Spot",
          { locationSpot: go.Spot.Center, locationObjectName: "SHAPE_PANEL" },
          new go.Binding("location", "loc", go.Point.parse).makeTwoWay(
            go.Point.stringify
          ),
          $(
            go.Panel,
            "Spot",
            { name: "SHAPE_PANEL" },
            $(go.Shape, "Rectangle", {
              width: 50,
              height: 50,
              fill: "white",
              stroke: "red",
              strokeWidth: 2,
            }),
            $(go.Shape, {
              geometryString: "M0 15 C10 0, 20 30, 30 15",
              stroke: "red",
              strokeWidth: 2,
              width: 30,
              height: 15,
              fill: null,
            })
          ),
          $(
            go.Panel,
            "Vertical",
            { alignment: go.Spot.Center, margin: 4 },
            $(
              go.TextBlock,
              { font: "bold 11pt sans-serif", stroke: "red" },
              new go.Binding("text", "key")
            ),
            $(
              go.TextBlock,
              { font: "9pt sans-serif" },
              new go.Binding("text", "voltage", (v) => (v ? `${v}` : ""))
            ),
            $(
              go.TextBlock,
              { font: "9pt sans-serif", stroke: "red" },
              new go.Binding("text", "g", (g) => `G: ${g}`)
            ),
            $(
              go.TextBlock,
              { font: "9pt sans-serif" },
              new go.Binding("text", "l", (l) => `L: ${l}`)
            )
          )
        )
      );

      // é“¾æ¥æ¨¡æ¿: å¢åŠ äº† points çš„åŒå‘ç»‘å®šï¼Œä»¥ä¿å­˜ç”¨æˆ·çš„æŠ˜çº¿ä¿®æ”¹
      myDiagram.linkTemplate = $(
        ParallelRouteLink,
        {
          routing: go.Link.Normal,
          reshapable: true, // å…è®¸æˆ‘ä»¬çš„è‡ªå®šä¹‰å·¥å…·ä¿®æ”¹å®ƒ
          adjusting: go.LinkAdjusting.End, // æ‹–åŠ¨èŠ‚ç‚¹æ—¶ï¼Œå°½é‡ä¿æŒç”¨æˆ·åˆ›å»ºçš„æŠ˜ç‚¹
        },
        new go.Binding("curviness"),
        new go.Binding("points").makeTwoWay(), // **å…³é”®**ï¼šå°†æŠ˜ç‚¹æ•°æ®å†™å›æ¨¡å‹ï¼Œä»¥ä¾¿ä¿å­˜
        $(
          go.Shape,
          { strokeWidth: 2, stroke: "black" },
          new go.Binding("stroke", "color")
        ),
        $(
          go.TextBlock,
          {
            segmentOffset: new go.Point(0, -10),
            font: "9pt sans-serif",
            background: "white",
          },
          new go.Binding("text", "label")
        )
      );

      // è‡ªåŠ¨åˆ†é… curviness å€¼çš„è¾…åŠ©å‡½æ•° (æ— å˜åŒ–)
      function assignCurviness(linkDataArray) {
        const linkGroups = new Map();
        for (const link of linkDataArray) {
          const from = link.from;
          const to = link.to;
          const key = from < to ? `${from}|${to}` : `${to}|${from}`;
          if (!linkGroups.has(key)) linkGroups.set(key, []);
          linkGroups.get(key).push(link);
        }
        for (const group of linkGroups.values()) {
          if (group.length > 1) {
            const total = group.length;
            const spacing = 8;
            group.forEach((link, index) => {
              link.curviness = (index - (total - 1) / 2) * spacing;
            });
          }
        }
      }

      // åŸå§‹æ•°æ®
      const originalNodeData = [
        { key: "å¹³å¯¨ç«™", l: "-168.1", loc: "0 50" },
        { key: "é»é˜³ç«™", l: "-198.2", loc: "150 0" },
        { key: "æ–°å¡˜ç«™", l: "-66.1", color: "red", loc: "300 50" },
        { key: "å²©å¤´å¯¨", g: "0", l: "321.3", loc: "0 250" },
        { key: "è‰é‹å³", l: "-187.9", loc: "150 250" },
        { key: "ç¿æ‘ç«™", l: "-1182.0", loc: "300 200" },
        {
          key: "å®‰æ°‘ç”µå‚",
          category: "Generator",
          g: 297.6,
          l: 19.8,
          loc: "150 400",
        },
        { key: "ä¼˜çš„ç«™", l: "91.3", loc: "0 500" },
        { key: "ç¤¾æ´åŸºç«™", l: "78.4", loc: "150 600" },
        {
          key: "ç¿å¥‡ç”µå‚",
          category: "Generator",
          g: 173.7,
          l: 11.4,
          loc: "650 500",
        },
        { key: "ç¿å˜ç«™", l: "-153.8", loc: "150 800" },
        { key: "æ¨å®¶ç«™", l: "-105.7", loc: "300 650" },
        { key: "åœ°ç½—ç«™", l: "-153.9", loc: "450 700" },
        { key: "å…¸éƒç«™", l: "97.5", loc: "450 850" },
        { key: "è¥¿å‡‰ç«™", l: "127.2", loc: "450 500" },
        { key: "å¾—ä½‘ç«™", l: "157.4", loc: "300 450" },
        { key: "æ’åŠç«™", l: "7.0", loc: "450 350" },
        { key: "åŠŸå¾·ç«™", l: "42.5", loc: "450 250" },
        { key: "å¹³æœç«™", l: "-4.7", loc: "600 300" },
        { key: "ä¸Šæ´ç«™", l: "9.0", loc: "600 150" },
        { key: "æŒ‚æ¦œç«™", l: "179.4", loc: "750 350" },
        { key: "ä½³åŸç«™", l: "0.2", loc: "750 50" },
        { key: "ç”²æ‹‰ç«™", l: "121.4", loc: "900 450" },
        { key: "æ–°å¡˜ç«™-åˆ†æ¥", l: "-422.5", color: "red", loc: "450 20" },
        { key: "ç™½æºªç«™", l: "-95.2", loc: "900 150" },
        {
          key: "é‡‘æ³‰ç”µå‚",
          category: "Generator",
          g: 220.3,
          l: 18.2,
          loc: "900 280",
        },
        { key: "é‡‘åªç«™", l: "-120.5", loc: "1050 260" },
        { key: "ä¸œè¥¿æ´ç«™", l: "-85.6", loc: "1050 450" },
        { key: "è°·å³°ç«™", l: "-141.8", loc: "1200 360" },
        { key: "åŒå—ç«™", l: "68.0", loc: "1200 520" },
      ];
      const originalLinkData = [
        {
          from: "å¹³å¯¨ç«™",
          to: "é»é˜³ç«™",
          label: "1.7070+j16.1090",
          color: "#009900",
        },
        {
          from: "é»é˜³ç«™",
          to: "æ–°å¡˜ç«™",
          label: "2.2390+j1.9940",
          color: "#009900",
        },
        {
          from: "é»é˜³ç«™",
          to: "å²©å¤´å¯¨",
          label: "2.9860-j660.1540",
          color: "#009900",
        },
        {
          from: "å²©å¤´å¯¨",
          to: "æ–°å¡˜ç«™-åˆ†æ¥",
          label: "0.7000-j8.4820",
          color: "#ff0000",
        },
        {
          from: "å²©å¤´å¯¨",
          to: "æ–°å¡˜ç«™-åˆ†æ¥",
          label: "0.7000-j8.4820",
          color: "#ff0000",
        },
        {
          from: "æ–°å¡˜ç«™-åˆ†æ¥",
          to: "ä½³åŸç«™",
          label: "0.7300-j8.4820",
          color: "#ff0000",
        },

        // --- å¢åŠ ä¸‰å›çº¿ç¤ºä¾‹ ---
        {
          from: "å²©å¤´å¯¨",
          to: "è‰é‹å³",
          label: "0.7810-j8.9540",
          color: "#009900",
        },
        {
          from: "å²©å¤´å¯¨",
          to: "è‰é‹å³",
          label: "0.7810-j8.9540",
          color: "#009900",
        },
        {
          from: "å²©å¤´å¯¨",
          to: "è‰é‹å³",
          label: "0.7810-j8.9540",
          color: "#009900",
        },

        {
          from: "å²©å¤´å¯¨",
          to: "ä¼˜çš„ç«™",
          label: "3.2180+j3.1750",
          color: "#009900",
        },
        {
          from: "ä¼˜çš„ç«™",
          to: "ç¤¾æ´åŸºç«™",
          label: "0.8230+j8.0490",
          color: "#009900",
        },
        {
          from: "ç¤¾æ´åŸºç«™",
          to: "å®‰æ°‘ç”µå‚",
          label: "0.2880+j2.9810",
          color: "#009900",
        },
        {
          from: "ç¤¾æ´åŸºç«™",
          to: "å®‰æ°‘ç”µå‚",
          label: "0.2880+j2.9810",
          color: "#009900",
        },
        {
          from: "ç¤¾æ´åŸºç«™",
          to: "å®‰æ°‘ç”µå‚",
          label: "0.2880+j2.9810",
          color: "#009900",
        },
        {
          from: "ç¤¾æ´åŸºç«™",
          to: "æ¨å®¶ç«™",
          label: "1.2480+j6.4480",
          color: "#009900",
        },
        {
          from: "æ¨å®¶ç«™",
          to: "ç¿å˜ç«™",
          label: "2.6100+j5.1020",
          color: "#009900",
        },
        {
          from: "æ¨å®¶ç«™",
          to: "åœ°ç½—ç«™",
          label: "1.6900-j5.0020",
          color: "#009900",
        },
        {
          from: "åœ°ç½—ç«™",
          to: "å…¸éƒç«™",
          label: "0.4500+j1.2290",
          color: "#009900",
        },
        {
          from: "åœ°ç½—ç«™",
          to: "è¥¿å‡‰ç«™",
          label: "0.8820+j1.0200",
          color: "#009900",
        },

        // --- å¢åŠ å››å›çº¿ç¤ºä¾‹ ---
        {
          from: "è¥¿å‡‰ç«™",
          to: "å®‰æ°‘ç”µå‚",
          label: "0.6690+j4.3650",
          color: "#009900",
        },
        {
          from: "è¥¿å‡‰ç«™",
          to: "å®‰æ°‘ç”µå‚",
          label: "0.6690+j4.3650",
          color: "#009900",
        },
        {
          from: "è¥¿å‡‰ç«™",
          to: "å®‰æ°‘ç”µå‚",
          label: "0.6690+j4.3650",
          color: "#009900",
        },
        {
          from: "è¥¿å‡‰ç«™",
          to: "å®‰æ°‘ç”µå‚",
          label: "0.6690+j4.3650",
          color: "#009900",
        },

        {
          from: "å®‰æ°‘ç”µå‚",
          to: "å¾—ä½‘ç«™",
          label: "0.3320-j2.9580",
          color: "#009900",
        },
        {
          from: "å®‰æ°‘ç”µå‚",
          to: "è‰é‹å³",
          label: "0.8890+j4.8610",
          color: "#009900",
        },
        {
          from: "è‰é‹å³",
          to: "ç¿æ‘ç«™",
          label: "4.4790-j102.6220",
          color: "#009900",
        },
        {
          from: "å¾—ä½‘ç«™",
          to: "æ’åŠç«™",
          label: "0.2920+j6.2620",
          color: "#009900",
        },
        {
          from: "æ’åŠç«™",
          to: "åŠŸå¾·ç«™",
          label: "0.9190+j6.6010",
          color: "#009900",
        },
        {
          from: "åŠŸå¾·ç«™",
          to: "æ–°å¡˜ç«™-åˆ†æ¥",
          label: "0.7670+j5.6970",
          color: "#009900",
        },

        // --- å¢åŠ å¦ä¸€ç»„ä¸‰å›çº¿ç¤ºä¾‹ ---
        {
          from: "åŠŸå¾·ç«™",
          to: "å¹³æœç«™",
          label: "0.8410+j1.066",
          color: "#009900",
        },
        {
          from: "åŠŸå¾·ç«™",
          to: "å¹³æœç«™",
          label: "0.8410+j1.066",
          color: "#009900",
        },
        {
          from: "åŠŸå¾·ç«™",
          to: "å¹³æœç«™",
          label: "0.8410+j1.066",
          color: "#009900",
        },

        {
          from: "å¹³æœç«™",
          to: "ä¸Šæ´ç«™",
          label: "1.0920+j1.1860",
          color: "#009900",
        },
        {
          from: "ä¸Šæ´ç«™",
          to: "ä½³åŸç«™",
          label: "2.3100+j7.2880",
          color: "#009900",
        },
        {
          from: "ä½³åŸç«™",
          to: "ç”²æ‹‰ç«™",
          label: "1.1190+j4.1980",
          color: "#009900",
        },
        {
          from: "ç”²æ‹‰ç«™",
          to: "ç¿å¥‡ç”µå‚",
          label: "1.0930+j4.1680",
          color: "#009900",
        },
        {
          from: "æŒ‚æ¦œç«™",
          to: "ç¿å¥‡ç”µå‚",
          label: "0.7970-j0.8870",
          color: "#009900",
        },
        {
          from: "æŒ‚æ¦œç«™",
          to: "å¹³æœç«™",
          label: "1.0920+j1.1860",
          color: "#009900",
        },
        {
          from: "æŒ‚æ¦œç«™",
          to: "å¹³æœç«™",
          label: "1.0920+j1.1860",
          color: "#009900",
        },
        {
          from: "è¥¿å‡‰ç«™",
          to: "ç¿å¥‡ç”µå‚",
          label: "3.9860+j12.4840",
          color: "#009900",
        },
        {
          from: "è¥¿å‡‰ç«™",
          to: "ç¿å¥‡ç”µå‚",
          label: "3.9860+j12.4840",
          color: "#009900",
        },
        {
          from: "ä½³åŸç«™",
          to: "ç™½æºªç«™",
          label: "4å·çº¿ 1.3180+j5.4420",
          color: "#0050c8",
        },
        {
          from: "ç™½æºªç«™",
          to: "é‡‘åªç«™",
          label: "4å·çº¿ 1.9280+j4.8710",
          color: "#0050c8",
        },
        {
          from: "é‡‘åªç«™",
          to: "è°·å³°ç«™",
          label: "4å·çº¿ 1.1100+j3.7860",
          color: "#0050c8",
        },
        {
          from: "è°·å³°ç«™",
          to: "ç”²æ‹‰ç«™",
          label: "4å·çº¿ 0.9820+j3.1220",
          color: "#0050c8",
        },
        {
          from: "ç™½æºªç«™",
          to: "ä¸Šæ´ç«™",
          label: "5å·çº¿ 1.5680+j4.0250",
          color: "#7811d7",
        },
        {
          from: "é‡‘åªç«™",
          to: "ä¸œè¥¿æ´ç«™",
          label: "5å·çº¿ 0.8450+j2.7750",
          color: "#7811d7",
        },
        {
          from: "ä¸œè¥¿æ´ç«™",
          to: "è¥¿å‡‰ç«™",
          label: "5å·çº¿ 1.2100+j3.4950",
          color: "#7811d7",
        },
        {
          from: "ä¸œè¥¿æ´ç«™",
          to: "åŒå—ç«™",
          label: "è”ç»œ 0.9560+j2.8800",
          color: "#00aaee",
        },
        {
          from: "åŒå—ç«™",
          to: "ç¿å¥‡ç”µå‚",
          label: "è”ç»œ 0.7150+j2.2650",
          color: "#00aaee",
        },
        {
          from: "é‡‘æ³‰ç”µå‚",
          to: "é‡‘åªç«™",
          label: "é‡‘æ³‰ 0.5320+j2.6100",
          color: "#ff6600",
        },
        {
          from: "é‡‘æ³‰ç”µå‚",
          to: "ä½³åŸç«™",
          label: "é‡‘æ³‰ 0.4100+j2.1020",
          color: "#ff6600",
        },
        {
          from: "é‡‘æ³‰ç”µå‚",
          to: "ç™½æºªç«™",
          label: "é‡‘æ³‰ 0.4100+j2.1020",
          color: "#ff6600",
        },
      ];

      // =================================================================================
      // ### æ–°å¢: ä¿å­˜ä¸åŠ è½½åŠŸèƒ½ ###
      // =================================================================================
      const feedback = document.getElementById("feedback");

      function saveDiagram() {
        const json = myDiagram.model.toJson();
        localStorage.setItem("powerGridDiagramData", json);
        feedback.textContent = "âœ… å¸ƒå±€å·²æˆåŠŸä¿å­˜ï¼";
        setTimeout(() => (feedback.textContent = ""), 2000);
      }

      function loadDiagram() {
        const json = localStorage.getItem("powerGridDiagramData");
        if (json) {
          myDiagram.model = go.Model.fromJson(JSON.parse(json));
          feedback.textContent = "âœ… å·²åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„å¸ƒå±€ã€‚";
          setTimeout(() => (feedback.textContent = ""), 2000);
        } else {
          feedback.textContent = "â„¹ï¸ æœªæ‰¾åˆ°å·²ä¿å­˜çš„å¸ƒå±€ã€‚";
          setTimeout(() => (feedback.textContent = ""), 2000);
        }
      }

      function resetDiagram() {
        if (confirm("æ‚¨ç¡®å®šè¦é‡ç½®å¸ƒå±€å—ï¼Ÿæ‰€æœ‰æœªä¿å­˜çš„ä¿®æ”¹éƒ½å°†ä¸¢å¤±ã€‚")) {
          localStorage.removeItem("powerGridDiagramData");
          const nodeDataCopy = JSON.parse(JSON.stringify(originalNodeData));
          const linkDataCopy = JSON.parse(JSON.stringify(originalLinkData));
          assignCurviness(linkDataCopy);
          myDiagram.model = new go.GraphLinksModel(nodeDataCopy, linkDataCopy);
          feedback.textContent = "ğŸ”„ å¸ƒå±€å·²é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€ã€‚";
          setTimeout(() => (feedback.textContent = ""), 2000);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("saveButton")
          .addEventListener("click", saveDiagram);
        document
          .getElementById("loadButton")
          .addEventListener("click", loadDiagram);
        document
          .getElementById("resetButton")
          .addEventListener("click", resetDiagram);

        const savedJson = localStorage.getItem("powerGridDiagramData");
        if (savedJson) {
          myDiagram.model = go.Model.fromJson(JSON.parse(savedJson));
        } else {
          const nodeDataCopy = JSON.parse(JSON.stringify(originalNodeData));
          const linkDataCopy = JSON.parse(JSON.stringify(originalLinkData));
          assignCurviness(linkDataCopy);
          myDiagram.model = new go.GraphLinksModel(nodeDataCopy, linkDataCopy);
        }
      });
      // =================================================================================
    </script>
  </body>
</html>
